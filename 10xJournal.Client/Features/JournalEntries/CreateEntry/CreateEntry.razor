@namespace _10xJournal.Client.Features.JournalEntries.CreateEntry

@page "/journal/create"
@using _10xJournal.Client.Features.JournalEntries.Models
@using _10xJournal.Client.Features.JournalEntries.CreateEntry
@using _10xJournal.Client.Features.Authentication.Services
@inject Supabase.Client SupabaseClient
@inject NavigationManager NavigationManager
@inject ILogger<CreateEntry> Logger
@inject CurrentUserAccessor CurrentUserAccessor

<PageTitle>Create New Entry</PageTitle>

<h1>Create New Journal Entry</h1>

<EditForm Model="@request" OnValidSubmit="HandleValidSubmitAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="content" class="form-label">Your thoughts for today:</label>
        <InputTextArea id="content" @bind-Value="request.Content" class="form-control" rows="10" />
    </div>

    <button type="submit" class="btn btn-primary" disabled="@isLoading">
        @if (isLoading)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span>Saving...</span>
        }
        else
        {
            <span>Save Entry</span>
        }
    </button>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3" role="alert">
            @errorMessage
        </div>
    }
</EditForm>

@code {
    private CreateJournalEntryRequest request = new CreateJournalEntryRequest();
    private bool isLoading = false;
    private string? errorMessage = null;

    private async Task HandleValidSubmitAsync()
    {
        isLoading = true;
        errorMessage = null;
        var correlationId = Guid.NewGuid();

        try
        {
            if (SupabaseClient == null)
                throw new InvalidOperationException("Supabase client is not available.");

            var currentUserId = await CurrentUserAccessor.GetCurrentUserIdAsync();
            if (currentUserId == null || currentUserId == Guid.Empty)
            {
                throw new InvalidOperationException("Could not determine current user id. Ensure authentication is configured or enable the development override.");
            }

            var newEntry = new JournalEntry { Content = request.Content, UserId = currentUserId.Value };
            var response = await SupabaseClient.From<JournalEntry>().Insert(newEntry);
            var createdEntry = response.Model;

            if (createdEntry != null)
            {
                Logger.LogInformation("Successfully created journal entry with ID: {EntryId}", createdEntry.Id);
                NavigationManager.NavigateTo("/journal/entries");
            }
            else
            {
                throw new InvalidOperationException("Failed to create journal entry. The response model was null.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating journal entry. Correlation ID: {CorrelationId}", correlationId);
            errorMessage = $"An error occurred while saving your entry. Please try again. Error ID: {correlationId}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
